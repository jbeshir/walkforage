// Technology Tree - Based on real historical material progression
// Each tech has realistic prerequisites based on material science

import { Technology, TechEra } from '../types/tech';

export const TECHNOLOGIES: Technology[] = [
  // ===== STONE AGE =====
  {
    id: 'flint_knapping',
    name: 'Flint Knapping',
    era: 'stone',
    description: 'The fundamental skill of striking stone to create sharp edges.',
    prerequisites: [],
    resourceCost: [{ resourceId: 'flint', quantity: 5 }],
    unlocks: ['stone_tools', 'basket_weaving'],
    enablesBuildings: [],
    enablesRecipes: ['hammerstone', 'grinding_stone', 'pressure_flaker', 'stone_knife', 'stone_scraper', 'flint_blade', 'crude_handle', 'fiber_binding'],
    icon: 'hammer',
    position: { x: 0, y: 0 },
  },
  {
    id: 'stone_tools',
    name: 'Stone Tools',
    era: 'stone',
    description: 'Hafted stone tools for chopping and cutting.',
    prerequisites: [{ techId: 'flint_knapping', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'flint', quantity: 10 },
      { resourceId: 'pine', quantity: 5 },
    ],
    unlocks: ['woodworking', 'hunting_tools'],
    enablesBuildings: [],
    enablesRecipes: ['stone_axe', 'stone_adze', 'stone_hammer', 'stone_axe_head', 'shaped_handle', 'leather_binding'],
    gatheringBonus: { resourceType: 'wood', multiplier: 1.5 },
    icon: 'axe',
    position: { x: 1, y: 0 },
  },
  {
    id: 'woodworking',
    name: 'Basic Woodworking',
    era: 'stone',
    description: 'Shaping softwood with stone tools.',
    prerequisites: [{ techId: 'stone_tools', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'pine', quantity: 20 },
      { resourceId: 'flint', quantity: 5 },
    ],
    unlocks: ['wooden_shelter', 'fire_making'],
    enablesBuildings: ['lean_to', 'wood_pile'],
    enablesRecipes: ['wooden_bowl', 'digging_stick'],
    icon: 'tree',
    position: { x: 2, y: -1 },
  },
  {
    id: 'fire_making',
    name: 'Fire Making',
    era: 'stone',
    description: 'Creating fire through friction or sparks.',
    prerequisites: [{ techId: 'woodworking', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'pine', quantity: 10 },
      { resourceId: 'flint', quantity: 3 },
    ],
    unlocks: ['pottery', 'charcoal_production'],
    enablesBuildings: ['fire_pit', 'smoking_rack'],
    enablesRecipes: ['hand_drill', 'bow_drill', 'torch'],
    icon: 'flame',
    position: { x: 3, y: -1 },
  },
  {
    id: 'basket_weaving',
    name: 'Basket Weaving',
    era: 'stone',
    description: 'Creating containers from plant fibers.',
    prerequisites: [{ techId: 'flint_knapping', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'pine', quantity: 15 }],
    unlocks: ['clay_gathering'],
    enablesBuildings: [],
    enablesRecipes: ['basket', 'fish_trap'],
    icon: 'basket',
    position: { x: 1, y: 1 },
  },
  {
    id: 'clay_gathering',
    name: 'Clay Gathering',
    era: 'stone',
    description: 'Finding and preparing clay for use.',
    prerequisites: [{ techId: 'basket_weaving', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'clay', quantity: 20 }],
    unlocks: ['pottery'],
    enablesBuildings: ['clay_pit'],
    enablesRecipes: ['clay_brick_unfired'],
    gatheringBonus: { resourceType: 'clay', multiplier: 2.0 },
    icon: 'droplet',
    position: { x: 2, y: 1 },
  },
  {
    id: 'pottery',
    name: 'Pottery',
    era: 'stone',
    description: 'Firing clay to create durable vessels.',
    prerequisites: [
      { techId: 'fire_making', type: 'prerequisite' },
      { techId: 'clay_gathering', type: 'prerequisite' },
    ],
    resourceCost: [
      { resourceId: 'clay', quantity: 30 },
      { resourceId: 'pine', quantity: 20 },
    ],
    unlocks: [],
    enablesBuildings: ['pottery_kiln'],
    enablesRecipes: ['clay_crucible', 'clay_pot', 'clay_jar', 'clay_brick'],
    icon: 'pot',
    position: { x: 3, y: 1 },
  },

  // ===== COPPER AGE =====
  {
    id: 'charcoal_production',
    name: 'Charcoal Production',
    era: 'copper',
    description: 'Converting wood to charcoal for high-temperature fires. CRITICAL for metallurgy.',
    prerequisites: [{ techId: 'fire_making', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'pine', quantity: 50 }],
    unlocks: ['simple_kiln'],
    enablesBuildings: ['charcoal_clamp'],
    enablesRecipes: ['charcoal'],
    icon: 'fire',
    position: { x: 4, y: -1 },
  },
  {
    id: 'simple_kiln',
    name: 'Simple Kiln',
    era: 'copper',
    description: 'A clay structure for achieving higher temperatures.',
    prerequisites: [
      { techId: 'charcoal_production', type: 'prerequisite' },
      { techId: 'pottery', type: 'prerequisite' },
    ],
    resourceCost: [
      { resourceId: 'clay', quantity: 50 },
      { resourceId: 'limestone', quantity: 20 },
    ],
    unlocks: ['copper_smelting', 'lime_burning'],
    enablesBuildings: ['kiln'],
    enablesRecipes: [],
    icon: 'kiln',
    position: { x: 5, y: 0 },
  },
  {
    id: 'copper_smelting',
    name: 'Copper Smelting',
    era: 'copper',
    description: 'Extracting copper from malachite ore at 1,100°C.',
    prerequisites: [{ techId: 'simple_kiln', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'malachite', quantity: 20 },
      { resourceId: 'charcoal', quantity: 30 },
    ],
    unlocks: ['copper_tools', 'copper_casting'],
    enablesBuildings: ['smelter'],
    enablesRecipes: ['copper_ingot'],
    icon: 'ingot',
    position: { x: 6, y: -1 },
  },
  {
    id: 'copper_tools',
    name: 'Copper Tools',
    era: 'copper',
    description: 'Tools made from smelted copper. Softer than stone but reshapeable.',
    prerequisites: [{ techId: 'copper_smelting', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'copper_ingot', quantity: 10 }],
    unlocks: ['hardwood_working', 'soft_stone_quarrying'],
    enablesBuildings: [],
    enablesRecipes: ['copper_knife', 'copper_axe', 'copper_adze', 'copper_chisel', 'copper_hammer', 'copper_pickaxe', 'tongs', 'copper_axe_head', 'copper_band'],
    gatheringBonus: { resourceType: 'stone', multiplier: 1.5 },
    icon: 'tools',
    position: { x: 7, y: -1 },
  },
  {
    id: 'hardwood_working',
    name: 'Hardwood Working',
    era: 'copper',
    description: 'Working oak, ash, and other dense woods requires metal tools.',
    prerequisites: [{ techId: 'copper_tools', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'oak', quantity: 20 },
      { resourceId: 'copper_ingot', quantity: 5 },
    ],
    unlocks: ['advanced_joinery'],
    enablesBuildings: ['carpentry_workshop'],
    enablesRecipes: ['hardwood_handle', 'copper_bellows', 'wooden_wedge'],
    gatheringBonus: { resourceType: 'hardwood', multiplier: 2.0 },
    icon: 'hammer',
    position: { x: 8, y: -2 },
  },
  {
    id: 'lime_burning',
    name: 'Lime Burning',
    era: 'copper',
    description: 'Heating limestone to create quicklime for mortar.',
    prerequisites: [{ techId: 'simple_kiln', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'limestone', quantity: 40 },
      { resourceId: 'charcoal', quantity: 20 },
    ],
    unlocks: ['lime_mortar'],
    enablesBuildings: ['lime_kiln'],
    enablesRecipes: ['quickite'],
    icon: 'stone',
    position: { x: 6, y: 1 },
  },
  {
    id: 'lime_mortar',
    name: 'Lime Mortar',
    era: 'copper',
    description: 'Mixing slaked lime with sand creates durable mortar.',
    prerequisites: [{ techId: 'lime_burning', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'quicklite', quantity: 20 },
      { resourceId: 'sandstone', quantity: 30 },
    ],
    unlocks: ['stone_masonry'],
    enablesBuildings: [],
    enablesRecipes: ['lime_mortar'],
    icon: 'brick',
    position: { x: 7, y: 1 },
  },
  {
    id: 'stone_masonry',
    name: 'Stone Masonry',
    era: 'copper',
    description: 'Building permanent structures from cut stone and mortar.',
    prerequisites: [
      { techId: 'lime_mortar', type: 'prerequisite' },
      { techId: 'soft_stone_quarrying', type: 'prerequisite' },
    ],
    resourceCost: [
      { resourceId: 'limestone', quantity: 100 },
      { resourceId: 'lime_mortar', quantity: 50 },
    ],
    unlocks: [],
    enablesBuildings: ['stone_house', 'stone_wall', 'stone_tower'],
    enablesRecipes: ['stone_block'],
    icon: 'building',
    position: { x: 8, y: 1 },
  },
  {
    id: 'soft_stone_quarrying',
    name: 'Soft Stone Quarrying',
    era: 'copper',
    description: 'Extracting limestone and sandstone blocks with copper tools.',
    prerequisites: [{ techId: 'copper_tools', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'limestone', quantity: 50 },
      { resourceId: 'copper_ingot', quantity: 5 },
    ],
    unlocks: ['stone_masonry'],
    enablesBuildings: ['quarry_soft'],
    enablesRecipes: ['limestone_block', 'sandstone_block'],
    gatheringBonus: { resourceType: 'sedimentary', multiplier: 2.0 },
    icon: 'mountain',
    position: { x: 8, y: 0 },
  },

  // ===== BRONZE AGE =====
  {
    id: 'tin_discovery',
    name: 'Tin Discovery',
    era: 'bronze',
    description: 'Finding and smelting cassiterite ore. Rare but essential for bronze.',
    prerequisites: [{ techId: 'copper_smelting', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'cassiterite', quantity: 10 },
      { resourceId: 'charcoal', quantity: 20 },
    ],
    unlocks: ['bronze_alloy'],
    enablesBuildings: [],
    enablesRecipes: ['tin_ingot'],
    icon: 'search',
    position: { x: 7, y: -2 },
  },
  {
    id: 'bronze_alloy',
    name: 'Bronze Alloy',
    era: 'bronze',
    description: 'Combining copper (90%) and tin (10%) to create bronze.',
    prerequisites: [{ techId: 'tin_discovery', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'copper_ingot', quantity: 9 },
      { resourceId: 'tin_ingot', quantity: 1 },
    ],
    unlocks: ['bronze_tools', 'bronze_casting'],
    enablesBuildings: ['bronze_foundry'],
    enablesRecipes: ['bronze_ingot'],
    icon: 'alloy',
    position: { x: 8, y: -3 },
  },
  {
    id: 'bronze_tools',
    name: 'Bronze Tools',
    era: 'bronze',
    description: 'Superior tools that hold edges better than copper.',
    prerequisites: [{ techId: 'bronze_alloy', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'bronze_ingot', quantity: 15 }],
    unlocks: ['advanced_carpentry', 'monument_building'],
    enablesBuildings: [],
    enablesRecipes: ['bronze_knife', 'bronze_adze', 'bronze_axe', 'bronze_chisel', 'bronze_saw', 'bronze_rasp', 'bronze_hammer', 'bronze_pickaxe', 'anvil', 'bronze_axe_head', 'precision_handle'],
    gatheringBonus: { resourceType: 'all', multiplier: 1.3 },
    craftingBonus: { category: 'all', speedMultiplier: 1.5 },
    icon: 'tools',
    position: { x: 9, y: -3 },
  },
  {
    id: 'advanced_carpentry',
    name: 'Advanced Carpentry',
    era: 'bronze',
    description: 'Mortise-tenon joints and complex wooden structures.',
    prerequisites: [
      { techId: 'bronze_tools', type: 'prerequisite' },
      { techId: 'hardwood_working', type: 'prerequisite' },
    ],
    resourceCost: [
      { resourceId: 'oak', quantity: 50 },
      { resourceId: 'bronze_ingot', quantity: 10 },
    ],
    unlocks: ['ship_building'],
    enablesBuildings: ['timber_frame_house', 'bridge'],
    enablesRecipes: ['mortise_joint', 'wooden_wheel'],
    icon: 'frame',
    position: { x: 10, y: -2 },
  },

  // ===== IRON AGE =====
  {
    id: 'bellows_technology',
    name: 'Bellows Technology',
    era: 'iron',
    description: 'Forced air increases furnace temperature to 1,250°C+.',
    prerequisites: [{ techId: 'bronze_tools', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'oak', quantity: 20 },
      { resourceId: 'leather', quantity: 10 },
    ],
    unlocks: ['shaft_furnace'],
    enablesBuildings: [],
    enablesRecipes: ['iron_bellows'],
    icon: 'wind',
    position: { x: 10, y: -4 },
  },
  {
    id: 'shaft_furnace',
    name: 'Shaft Furnace',
    era: 'iron',
    description: 'Tall furnace design that maintains higher temperatures.',
    prerequisites: [{ techId: 'bellows_technology', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'clay', quantity: 100 },
      { resourceId: 'granite', quantity: 50 },
    ],
    unlocks: ['iron_smelting'],
    enablesBuildings: ['bloomery'],
    enablesRecipes: [],
    icon: 'furnace',
    position: { x: 11, y: -4 },
  },
  {
    id: 'iron_smelting',
    name: 'Iron Smelting',
    era: 'iron',
    description: 'Extracting iron from hematite ore in a bloomery.',
    prerequisites: [{ techId: 'shaft_furnace', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'hematite', quantity: 30 },
      { resourceId: 'charcoal', quantity: 50 },
    ],
    unlocks: ['iron_working', 'smithing'],
    enablesBuildings: ['iron_smeltery'],
    enablesRecipes: ['iron_bloom', 'graphite_crucible'],
    icon: 'ingot',
    position: { x: 12, y: -4 },
  },
  {
    id: 'smithing',
    name: 'Smithing',
    era: 'iron',
    description: 'Hot-working iron bloom into usable metal.',
    prerequisites: [{ techId: 'iron_smelting', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'iron_bloom', quantity: 20 },
      { resourceId: 'charcoal', quantity: 30 },
    ],
    unlocks: ['iron_tools', 'steel_making'],
    enablesBuildings: ['smithy'],
    enablesRecipes: ['iron_bar', 'iron_tongs'],
    icon: 'anvil',
    position: { x: 13, y: -4 },
  },
  {
    id: 'iron_tools',
    name: 'Iron Tools',
    era: 'iron',
    description: 'Superior tools that outperform bronze in every way.',
    prerequisites: [{ techId: 'smithing', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'iron_bar', quantity: 20 }],
    unlocks: ['advanced_quarrying'],
    enablesBuildings: [],
    enablesRecipes: ['iron_knife', 'iron_adze', 'iron_hammer', 'iron_anvil', 'iron_axe', 'iron_chisel', 'iron_pickaxe', 'iron_saw', 'flint_and_steel', 'iron_axe_head', 'reinforced_handle', 'iron_ferrule'],
    gatheringBonus: { resourceType: 'all', multiplier: 1.5 },
    craftingBonus: { category: 'all', speedMultiplier: 2.0 },
    icon: 'tools',
    position: { x: 14, y: -4 },
  },
  {
    id: 'steel_making',
    name: 'Steel Making',
    era: 'iron',
    description: 'Adding carbon to iron creates steel at 1,300-1,400°C.',
    prerequisites: [{ techId: 'smithing', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'iron_bar', quantity: 30 },
      { resourceId: 'charcoal', quantity: 50 },
    ],
    unlocks: ['quenching', 'tempering'],
    enablesBuildings: ['steel_forge'],
    enablesRecipes: ['steel_ingot'],
    icon: 'star',
    position: { x: 14, y: -5 },
  },
  {
    id: 'quenching',
    name: 'Quenching',
    era: 'iron',
    description: 'Rapid cooling hardens steel dramatically.',
    prerequisites: [{ techId: 'steel_making', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'steel_ingot', quantity: 10 }],
    unlocks: ['steel_tools'],
    enablesBuildings: [],
    enablesRecipes: ['hardened_steel'],
    icon: 'droplet',
    position: { x: 15, y: -5 },
  },
  {
    id: 'steel_tools',
    name: 'Steel Tools',
    era: 'iron',
    description: 'The pinnacle of metalworking. Unmatched hardness and durability.',
    prerequisites: [{ techId: 'quenching', type: 'prerequisite' }],
    resourceCost: [{ resourceId: 'hardened_steel', quantity: 15 }],
    unlocks: [],
    enablesBuildings: [],
    enablesRecipes: ['steel_hammer', 'steel_axe', 'steel_pickaxe', 'steel_sword'],
    gatheringBonus: { resourceType: 'all', multiplier: 2.0 },
    craftingBonus: { category: 'all', speedMultiplier: 3.0 },
    icon: 'sword',
    position: { x: 16, y: -5 },
  },
  {
    id: 'advanced_quarrying',
    name: 'Advanced Quarrying',
    era: 'iron',
    description: 'Iron tools can work granite and other hard stones.',
    prerequisites: [{ techId: 'iron_tools', type: 'prerequisite' }],
    resourceCost: [
      { resourceId: 'iron_bar', quantity: 30 },
      { resourceId: 'granite', quantity: 50 },
    ],
    unlocks: [],
    enablesBuildings: ['quarry_hard'],
    enablesRecipes: ['granite_block', 'marble_block'],
    gatheringBonus: { resourceType: 'igneous', multiplier: 2.0 },
    icon: 'mountain',
    position: { x: 15, y: -3 },
  },
];

export const TECH_BY_ID = Object.fromEntries(
  TECHNOLOGIES.map(t => [t.id, t])
);

export function getTechsByEra(era: TechEra): Technology[] {
  return TECHNOLOGIES.filter(t => t.era === era);
}

export function getAvailableTechs(unlockedTechs: string[]): Technology[] {
  return TECHNOLOGIES.filter(tech => {
    // Already unlocked
    if (unlockedTechs.includes(tech.id)) return false;

    // Check all prerequisites are met
    return tech.prerequisites.every(prereq =>
      unlockedTechs.includes(prereq.techId)
    );
  });
}
